<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/exampleLayout}">

<th:block layout:fragment="css">
  <style>
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      text-align: center;
      margin-bottom: 20px;
    }

    .dashboard-header h2 {
      margin-bottom: 10px;
    }

    .dashboard-header .time {
      font-size: 1.1em;
      color: #555;
    }

    .main-layout {
      display: flex;
      gap: 30px;
    }

    .dashboard-container {
      flex: 3;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .dashboard-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dashboard-title {
      font-size: 18px;
      font-weight: bold;
    }

    .device-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .weather-box {
      flex: 1;
      background: #eef1f5;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .device-group {
      margin-bottom: 30px;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .sensor-card {
      height: 150px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
    }

    .sensor-value {
      font-size: 28px;
      font-weight: bold;
    }

    .sensor-location {
      font-size: 14px;
      color: #666;
    }

    .sensor-label {
      font-size: 16px;
      margin-top: 5px;
    }

    .normal {
      background-color: #d8f5d8; /* ë…¹ìƒ‰: ì •ìƒ */
    }

    .warning {
      background-color: #fcdede; /* ë¹¨ê°•: ì´ë²¤íŠ¸ ë°œìƒ */
    }
  </style>
</th:block>

<div layout:fragment="content" class="container">
  <div class="dashboard-header">
    <span class="header-title">GreenMonitor Dashboard</span>
    <span class="time" id="currentTime"></span>
  </div>

  <div class="main-layout">
    <div class="dashboard-container">
      <div class="dashboard-top">
        <div class="dashboard-title">Sensor Data</div>
        <div class="device-filter">
          <label for="deviceFilter">ë””ë°”ì´ìŠ¤ ì„ íƒ: </label>
          <select id="deviceFilter">
            <option value="ALL">ì „ì²´</option>
            <option value="ENV_V2_1">1F</option>
            <option value="ENV_V2_2">2F</option>
            <option value="ENV_V2_3">ìì¬ì‹¤</option>
            <option value="ENV_V2_4">í¬ì¥ì‹¤</option>
          </select>
        </div>
      </div>
      <div id="dashboard"></div>
    </div>

    <div class="weather-box">
      <h4>ğŸŒ¤ í˜„ì¬ ë‚ ì”¨</h4>
      <p>ë‚ ì”¨ API ì—°ë™ ì˜ˆì • ì˜ì—­ì…ë‹ˆë‹¤.</p>
      <p>ê¸°ì˜¨, ìŠµë„, ë¯¸ì„¸ë¨¼ì§€ ë“± í‘œì‹œ ê°€ëŠ¥</p>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <script>
    // ì„¼ì„œ ê°’ ì´ë¦„ ë°°ì—´
    const valueLabels = [
      "ì‹¤ë‚´ì˜¨ë„", "ìƒëŒ€ìŠµë„", "ì´ì‚°í™”íƒ„ì†Œ", "ìœ ê¸°í™”í•©ë¬¼VOC",
      "ì´ˆë¯¸ì„¸ë¨¼ì§€(PM1.0)", "ì´ˆë¯¸ì„¸ë¨¼ì§€(PM2.5)", "ë¯¸ì„¸ë¨¼ì§€(PM10)",
      "ëƒ‰ì¥ê³ _ì˜¨ë„1", "ëƒ‰ì¥ê³ _ì˜¨ë„2", "ëƒ‰ì¥ê³ _ì˜¨ë„3"
    ];

    // ë””ë°”ì´ìŠ¤ ì½”ë“œ â†’ ìœ„ì¹˜ëª… ë§¤í•‘
    const deviceMap = {
      "ENV_V2_1": "1F",
      "ENV_V2_2": "2F",
      "ENV_V2_3": "ìì¬ì‹¤",
      "ENV_V2_4": "í¬ì¥ì‹¤"
    };

    // í˜„ì¬ ì‹œê° í‘œì‹œ
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText = now.toLocaleString('ko-KR');
    }

    // ì„¼ì„œ ë°ì´í„° fetch
    function fetchLatestData() {
      $.ajax({
        url: '/admin/getLatestData',
        type: 'GET',
        dataType: 'json',
        success: function(res) {
          renderDashboard(res);
        },
        error: function(err) {
          console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        }
      });
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderDashboard(sensorList) {
      const selectedDevice = $('#deviceFilter').val();
      const dashboard = $('#dashboard');
      dashboard.empty();

      if (selectedDevice === 'ALL') {
        // ë””ë°”ì´ìŠ¤ë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ë Œë”ë§
        const grouped = {};
        sensorList.forEach(s => {
          if (!grouped[s.deviceCode]) grouped[s.deviceCode] = [];
          grouped[s.deviceCode].push(s);
        });

        for (const [deviceCode, sensors] of Object.entries(grouped)) {
          const groupDiv = $('<div class="device-group"></div>');
          const grid = $('<div class="dashboard"></div>');

          sensors.forEach(sensor => {
            for (let i = 1; i <= 10; i++) {
              const value = sensor['value' + i];
              const eventFlag = sensor['value' + i + 'Event'];
              const label = valueLabels[i - 1];
              const bgClass = eventFlag ? 'warning' : 'normal';

              const card = $(`
                <div class="sensor-card ${bgClass}">
                  <div class="sensor-label">${label}</div>
                  <div class="sensor-value">${value}</div>
                  <div class="sensor-location">${deviceMap[deviceCode]}</div>
                </div>
              `);
              grid.append(card);
            }
          });

          groupDiv.append(grid);
          dashboard.append(groupDiv);
        }

      } else {
        // íŠ¹ì • ë””ë°”ì´ìŠ¤ë§Œ ë³´ê¸°
        const selected = sensorList.find(s => s.deviceCode === selectedDevice);
        if (!selected) return;

        const grid = $('<div class="dashboard"></div>');

        for (let i = 1; i <= 10; i++) {
          const value = selected['value' + i];
          const eventFlag = selected['value' + i + 'Event'];
          const label = valueLabels[i - 1];
          const bgClass = eventFlag ? 'warning' : 'normal';

          const card = $(`
            <div class="sensor-card ${bgClass}">
              <div class="sensor-label">${label}</div>
              <div class="sensor-value">${value}</div>
              <div class="sensor-location">${deviceMap[selectedDevice]}</div>
            </div>
          `);
          grid.append(card);
        }

        dashboard.append(grid);
      }
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
    $(document).ready(function() {
      updateTime();
      setInterval(updateTime, 1000); // ì‹¤ì‹œê°„ ì‹œê° ê°±ì‹ 

      fetchLatestData();
      setInterval(fetchLatestData, 10000); // 10ì´ˆë§ˆë‹¤ ì„¼ì„œê°’ ê°±ì‹ 

      $('#deviceFilter').on('change', fetchLatestData); // í•„í„° ë³€ê²½ ì‹œ ê°±ì‹ 
    });
  </script>
</th:block>

</html>
